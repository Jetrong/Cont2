## Урок 2. Механизмы контрольных групп

### **Информация о проекте**

Задание 1:
1) запустить контейнер с ubuntu, используя механизм LXC;
2) ограничить контейнер 256 Мб ОЗУ и проверить, что ограничение работает;
3) добавить автозапуск контейнеру, перезагрузить ОС и убедиться, что контейнер действительно запустился самостоятельно;
4) при создании указать файл, куда записывать логи;
5) после перезагрузки проанализировать логи.

Задание 2*: настроить автоматическую маршрутизацию между контейнерами. Адреса можно взять: 10.0.12.0/24 и 10.0.13.0/24.

Задание со звездочкой - повышенной сложности, это нужно учесть при выполнении (но сделать его необходимо).

***ИЛИ***

***создать несколько процессов и вручную распределить их по разным контрольным группам ограничив различные ресурсы как на семинаре.***


**Задание**

* Установим LXC и шаблоны:
```
sudo apt install lxc lxc-templates uidmap
```

Затем командой "$ lxc version" проверяем уствновленную версию. Видим как система подсказывает, что для начала необходимо инициализировать LXD на машине. Вводим команду:
```
lxd init
```

После инициализации снова убеждаемся, что все нормально установлено, путем проверки версии LXC:
```
lxc version
```
![image](https://github.com/Jetrong/Cont2/assets/136317824/643015f1-51d8-4a7b-bfc7-ecc21743e884)

* Следующей командой создаем новый контейнер с именем testOne и задаем путь для файла конфигурации:
```
lxc-create -n testOne -t ubuntu -f /usr/share/doc/lxc/lxc-veth.conf 
```

Видим большое количество текста, значит команда введена правильно. В тексте указана ошибка открытия файла конфигурации указанного нами. На запуск контейнера это не повлияет, а случается из=за того, что такого файла на данном этапе не существует.

![image](https://github.com/Jetrong/Cont2/assets/136317824/2c329103-24a1-4fd4-bde2-08210fec4702)

После того, как контейнер установился мы видим следующий текст:

![image](https://github.com/Jetrong/Cont2/assets/136317824/a6e1a1ac-7603-47d0-a20f-c324d7710fbd)

Система оповещает нас о том, что контейнер создан, у него заданы стандартные параметры (логин: ubuntu, пароль: ubuntu).


* Теперь необходимо запустить созданный нами контейнер. Для этого вводим следующую команду:
```
sudo lxc-start -d -n testOne
```
![image](https://github.com/Jetrong/Cont2/assets/136317824/a9f904ab-431a-450d-9266-39b1d4b27ee3)

Если ситема никак не оповестила нас ни о чем, значит команда успешно выполнена. Проверить это можно, например, путем входа в контейнер:
```
sudo lxc-attach -n testOne
```

Видим, что мы зашли в testOne под root.

![image](https://github.com/Jetrong/Cont2/assets/136317824/0dbe1237-a4ec-483b-ad38-b22e53a53344)

* Вводим следующую команду для просмотра выделенной и свободной памяти:
```
free -m
```
![image](https://github.com/Jetrong/Cont2/assets/136317824/0bc470d9-de62-43e1-8731-81764ce22093)

Для удобства сразу перейдем в нужную папку:
```
cd sys/fs/cgroup
```

Считываем данные из файла, в котором уграничивается потребление памяти контейнером:
```
cat memory.max
```
Здесь мы можем наблюдать, что ограничение памяти установлено на максимальное значение.
![image](https://github.com/Jetrong/Cont2/assets/136317824/2076f231-7f3d-4d38-ab7c-2ff3f13ca4e5)

Далее выполним тоже самое из папки .lxc:

![image](https://github.com/Jetrong/Cont2/assets/136317824/d03bc0b6-fbe7-4748-9ad5-0baacf3628ba)

Убеждаемся в максимальном значении. Выходим из контейнера:
```
exit
```


Для того, что бы ограничить потребление памяти контейнером, необходимо добавить строку в файл конфигурации. Для начала считаем информацию из него и убедимся, что ограничений там нет командой:
```
sudo cat /var/lib/lxc/testOne/config
```
![image](https://github.com/Jetrong/Cont2/assets/136317824/7fabaff1-e751-432f-ad84-06159c277f34)

После этого любым удобным редактором (я делал через редактор nano) добавляем в этот файл конфигурации вниз текста следующую строку:

```
lxc.cgroup2.memory.max = 256M
```
![image](https://github.com/Jetrong/Cont2/assets/136317824/5a10bb4c-2995-477c-a3c1-967a329bdb72)

Таким образом мы ограничили потребление памяти на более 256 мб.
Останавливаем контейнер и снова запускаем его.
Вводим следующую команду, что бы убедиться, что ограничение работает:
```
sudo cat /sys/fs/cgroup/lxc.payload.testOne/mempry.max
```
![image](https://github.com/Jetrong/Cont2/assets/136317824/689ea369-f0eb-4ddd-8b72-92937060ee88)

* Далее просмотрим список имеющихся в нашей системе контейнеров:
```
sudo lxc-ls -f
```
 У нас имеется один контейнер testOne, он запущен и в автозапуске стоит 0 (что означает, что автозапуск контейнера отключен).
 Нам необходимо включить автозапуск, для этого октрываем файл конфигурации в редакторе nano:
```
sudo nano /var/lib/lxc/testOne/config
```
![image](https://github.com/Jetrong/Cont2/assets/136317824/dae2e545-a878-48db-a95f-94e30e3c02be)

Добавляем в конец текста файла конфигурации следующую строку:
```
lxc.start.auto = 1
```

Сохраняем, закрываем редактор и перезагружаем систему, например командой '$ reboot'.
![image](https://github.com/Jetrong/Cont2/assets/136317824/118eeb8c-f34b-46a9-8520-add95c08d8d5)

После перезагрузки снова выполняем команду:

```
sudo lxc-ls -f
```

Вводим пароль root и убеждаемся, что контейнер запущен и автозапуск включен.
![image](https://github.com/Jetrong/Cont2/assets/136317824/2712616a-de48-461f-86c9-de55e64b3c5b)

* При запуске контейнера можно в параметрах команды указать, где хранить логи, например:
```
lxc-start -n testOne --logfile log.log
```


* Для удаления контейнера необходмио воспользоваться следующей командой:
```
lxc-destroy -n testOne
```

Подготовил студент Geek Brains Анисимов Роман, containerization-Seminar_2
